#!/bin/bash
# Development環境デプロイスクリプト（v2.28.0対応）

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
KUBESPRAY_DIR="$(cd "${SCRIPT_DIR}/../../.." && pwd)"
INVENTORY_DIR="${KUBESPRAY_DIR}/inventory/development"
MASTER_IP="172.16.100.121"

echo "=========================================="
echo "Production Kubernetes Cluster Reset"
echo "=========================================="
echo "Kubespray Dir: ${KUBESPRAY_DIR}"
echo "Inventory Dir: ${INVENTORY_DIR}"
echo "Kubernetes Version: 1.31.3"
echo "Calico Version: v3.28.0"
echo ""

# 仮想環境確認
if [[ "$VIRTUAL_ENV" == "" ]]; then
    echo "エラー: Python仮想環境が有効化されていません"
    echo "実行: source ~/kubernetes/venv/bin/activate"
    exit 1
fi

# Ansible接続確認
echo "[1/4] Ansible接続確認..."
cd "${KUBESPRAY_DIR}"
ansible -i "${INVENTORY_DIR}/hosts.yml" all -m ping -o

# Inventory検証
echo ""
echo "[2/4] Inventory検証..."
ansible-inventory -i "${INVENTORY_DIR}/hosts.yml" --list

# クラスresetタ
echo ""
echo "[3/4] Kubernetesクラスタreset開始..."
# iptables関連タスクをスキップしてreset

ansible-playbook -i "${INVENTORY_DIR}/hosts.yml" \
    --become \
    --become-user=root \
    --skip-tags=iptables \
    -e ansible_user=jaist-lab \
    reset.yml

# manifestディレクトリが空であることを確認
ls -la /etc/kubernetes/manifests/

echo ""
echo "=========================================="
echo "✓ Production環境リセット完了"
echo "=========================================="
echo "# dev-master01の状態確認"
echo "ssh jaist-lab@172.16.100.121" 
echo "# Kubernetesプロセスが停止していることを確認"
echo "sudo systemctl status kubelet"
echo "# 出力: inactive (dead)"
echo "# ポートが空いていることを確認"
echo "sudo ss -tlnp | grep -E '6443|10250|10257|10259'"
echo "# 何も表示されなければOK"

